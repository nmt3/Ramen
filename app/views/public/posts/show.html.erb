<div class="container">
  <div class="row">
    <div class="error_messages">
      <% if @review.errors.any? %>
        <%= @review.errors.count %>件のエラーが発生しました
        <ul>
          <% @review.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      <% end %>
    </div>
    <div class="col-md-12">
      <div class="row">
        <div class="col-md-12 col-12">
          <h4>投稿者：
            <%= link_to list_customer_path(@post.customer.id) do %>
              <%= @post.customer.name  %>さん
            <% end %>
            <% if @post.customer == current_customer %>
              <%= link_to "投稿編集", edit_post_path(@post.id), class: "btn btn-primary" %>
            <% end %><br>
            <% if @post.bookmarked_by?(current_customer) %>
              <td>
                <%= link_to post_bookmark_path(@post, @post.bookmarks.first), method: :delete do %>
                 <i class="fas fa-heart unlike-btn"></i>
                <% end %>
              </td>
            <% else %>
              <td>
                <%= link_to post_bookmarks_path(@post), method: :post do %>
                  <i class="far fa-heart like-btn" ></i>
                <% end %>
              </td>
            <% end %>
            <%= @bookmarks_count %>件のいいね！
          </h4>
        </div>
        <div class="col-md-7 col-12">
          <table border="1" width="100%" class="store">
            <tbody>
              <tr>
                <td rowspan="8" width="25%" align="center">
                  <% if @post.image.attached? %>
                    <%=link_to @post.image, "data-lightbox": @post.image do %>
                      <%= image_tag @post.image, size: "140x140" %>
                    <% end %>
                  <% else %>
                    <%= image_tag "no_image", size: "140x140" %>
                  <% end %>
                </td>
              </tr>
              <tr>
                <th width="15%">店名</td>
                <td><%= @post.store_name %></td>
              </tr>
              <tr>
                <th>営業日</td>
                <td>
                  <%  weekly_columns.each_with_index do |day,i| %>
                    <% if @post[day] == true %>
                     <a><%= ["月","火","水","木","金","土","日"][i] %></a>
                    <% end %>
                  <% end %>
                </td>
              </tr>
              <tr>
                <th>営業時間</td>
                <td><%= @post.business_time %></td>
              </tr>
              <tr>
                <th>定休日</td>
                <td><%= @post.holiday %></td>
              </tr>
              <tr>
                <th>ジャンル</td>
                <td>
                  <% @post.tags.each do |tag| %>
                    <%= tag.genre %>
                  <% end %>
                </td>
              </tr>
              <tr>
                <th>コメント</td>
                <td><%= @post.post_comment %></td>
              </tr>
              <tr>
                <th>所在地</td>
                <td><%= @post.address %></td>
              </tr>
            </tbody>
          </table>
        </div>


        <div class="col-md-5 col-12">

          <div id='map'></div>

          <style>
          #map {
            height: 200px;
            width: 80%;
          }
          </style>

           <!--js部分-->
          <script>
          //初期マップの設定
          let map
          let marker
          function initMap(){
            geocoder = new google.maps.Geocoder()

            map = new google.maps.Map(document.getElementById('map'), {
              center:  {lat: <%= @post.lat %>, lng: <%= @post.lng %>},
              zoom: 15,
            });

             marker = new google.maps.Marker({
              position:  {lat: <%= @post.lat %>, lng: <%= @post.lng %>},
              map: map
            });
          }
          </script>
          <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAa1owy4YYR6jSHTGE21g4W8vO0wOS95SU&callback=initMap" async defer></script>
        </div>
      </div>
    </div>


  </div>
  <div class="row">
    <div class="col-md-10 col-sm-10">
      <div class="review">
        <h4>
          口コミ一覧
          <%= link_to "画像一覧", reviews_path(id: @post.id) %>
        </h4>
      </div>
    </div>
    <div class="col-md-2 col-sm-2">
      <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#exampleModal">
        口コミ投稿
      </button>
    </div>

      <!-- Modal -->
      <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <%= form_with model: @review, local: :true do |f| %>
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLabel">口コミ投稿</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <!--ここからが星レビュー機能-->
              <p class="label"><%= f.label "写真を追加(複数可)" %><br>
              <%= f.file_field :images, multiple: true %></p><br>
              <p class="label"><%= f.label :star, "評価" %></p>
              <div class="form-group" id="star">
                <%= f.hidden_field :star, id: :review_star %>
              </div>
              <script>
                $('#star').empty();
                var elem = document.getElementById("star");
                var opt = {
                  size : 36,
                  starOff: "<%= asset_path('star-off.png') %>",
                  starOn: "<%= asset_path('star-on.png') %>",
                  scoreName: 'review[star]',
                  half: false,
                };
                raty(elem, opt)
              </script>
              <!--ここまでが星レビュー機能-->
              <p class="label"><%= f.label :review_comment, "口コミ内容" %><br>
              <%= f.text_area :review_comment, size: "25%x10%" %></p>
              <%= f.hidden_field :post_id, value: @post.id %><br>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
              <%= f.submit "送信", class: "btn btn-success" %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col-md-12 col-sm-12">
        <%= paginate @reviews %>
        <% @reviews.each do |r| %>
          <div class="review_box">
            投稿日時:<%= r.created_at.strftime("%Y/%m/%d %H:%M") %>
            <% if r.customer.image.attached? %>
              <%= image_tag r.customer.image, size: "50x50" %>
            <% else %>
              <%= image_tag "no_image", size: "50x50" %>
            <% end %>
            <%= link_to list_customer_path(r.customer.id) do %>
              <%= r.customer.name %>
            <% end %>

            <% if r.customer == current_customer %>
              <%= link_to "削除", review_path(r.id), method: :delete, class: "btn btn-danger" %>
            <% end %><br>

            <%#= r.star %>

            <div id="star_<%= r.id %>"></div>

            <script>
              $('#star_<%= r.id %>').empty();
              // var elem = document.getElementById("star_<%= r.id %>");
              // var opt = {
              //   // size: 36,
              //   starOff: "<%= asset_path('star-off.png') %>",
              //   starOn: "<%= asset_path('star-on.png') %>",
              //   readOnly: true, // 読み知り専用
              //   score: <%= r.star %>, // score
              // };
              raty(document.getElementById("star_<%= r.id %>"), // 表示する場所のid
                {
                  starOff: "<%= asset_path('star-off.png') %>", // 星OFFの画像パス
                  starOn: "<%= asset_path('star-on.png') %>", // 星ONの画像パス
                  readOnly: true, // 読み知り専用
                  score: <%= r.star %>, // 表示する星の数
                }
              )
            </script>

            <% if r.images.attached? %>
              <% r.images.each do |image| %>
                <%=link_to image, "data-lightbox": image do %>
                  <%= image_tag image, size: '80x80' %>
                <% end %>
              <% end %>
            <% end %>
            <div class="review_comment">
              <%= r.review_comment %>
            </div>
          </div>
        <% end %>
        <%= paginate @reviews %>
    </div>
  </div>
</div>
